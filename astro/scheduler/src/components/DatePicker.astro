---
import { getDaysOfWeek, generateDateRange, formatDisplayDate, isToday } from '../utils/date-utils';

interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
const daysOfWeek = getDaysOfWeek();
---

<div class={className}>
  <div id="date-picker-container" class="glass-panel p-6">
    <div class="mb-4 text-center">
      <p class="text-sm font-medium text-muted-foreground">
        Select a date for your appointment
      </p>
    </div>
    
    <!-- Calendar Grid -->
    <div class="p-3 rounded-lg">
      <div id="datepicker" class="grid grid-cols-7 gap-1">
        {/* Days of the week */}
        {daysOfWeek.map(day => (
          <div class="text-center text-xs text-muted-foreground pb-1">{day}</div>
        ))}
      </div>
    </div>
    
    <div id="selected-date-display" class="mt-4 text-center hidden">
      <p class="text-sm font-medium text-foreground">
        Selected: <span id="selected-date" class="font-bold"></span>
      </p>
    </div>
  </div>
</div>

<script>
  import { startOfToday, addDays, format } from 'date-fns';
  import { generateDateRange, formatDisplayDate } from '../utils/date-utils';
  
  // Initialize the date picker
  function initDatepicker() {
    const today = startOfToday();
    const dates = generateDateRange(30);
    const datepicker = document.getElementById('datepicker');
    
    if (!datepicker) return;
    
    // Add dates to the grid
    dates.forEach((date, index) => {
      const dateEl = document.createElement('button');
      dateEl.className = 'rounded-md h-8 w-8 flex items-center justify-center text-sm hover:bg-primary/10 transition-colors';
      dateEl.textContent = date.getDate().toString();
      dateEl.dataset.date = date.toISOString();
      
      if (index === 0) {
        dateEl.classList.add('font-bold');
      }
      
      // Add date selection behavior
      dateEl.addEventListener('click', () => {
        handleDateSelection(dateEl, date);
      });
      
      datepicker.appendChild(dateEl);
    });
  }
  
  // Handle date selection
  function handleDateSelection(element, date) {
    // Reset all buttons
    const buttons = document.querySelectorAll('#datepicker button');
    buttons.forEach(btn => {
      btn.classList.remove('bg-primary', 'text-white');
    });
    
    // Style selected button
    element.classList.add('bg-primary', 'text-white');
    
    // Update selected date display
    const selectedDateDisplay = document.getElementById('selected-date-display');
    const selectedDateText = document.getElementById('selected-date');
    
    if (selectedDateDisplay && selectedDateText) {
      selectedDateText.textContent = formatDisplayDate(date);
      selectedDateDisplay.classList.remove('hidden');
    }
    
    // Dispatch custom event with selected date
    const customEvent = new CustomEvent('dateSelected', { 
      detail: { date: date }
    });
    document.dispatchEvent(customEvent);
  }
  
  // Initialize when the DOM is loaded
  document.addEventListener('DOMContentLoaded', initDatepicker);
</script>