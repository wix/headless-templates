---
import { getDaysOfWeek, generateDateRange, formatDisplayDate, isToday } from '../utils/date-utils';
import Panel from './ui/Panel.astro';
import Button from './ui/Button.astro';

interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
const daysOfWeek = getDaysOfWeek();
---

<div class={className}>
  <Panel id="date-picker-container">
    <div class="mb-4 text-center">
      <p class="text-sm font-medium text-muted-foreground">
        Select a date for your appointment
      </p>
    </div>
    
    <!-- Calendar Grid -->
    <div class="p-3 rounded-lg">
      <div id="datepicker" class="grid grid-cols-7 gap-1">
        {/* Days of the week */}
        {daysOfWeek.map(day => (
          <div class="text-center text-xs text-muted-foreground pb-1">{day}</div>
        ))}
      </div>
    </div>
    
    <div id="selected-date-display" class="mt-4 text-center hidden">
      <p class="text-sm font-medium text-foreground">
        Selected: <span id="selected-date" class="font-bold"></span>
      </p>
    </div>
  </Panel>
</div>

<script>
  import { startOfToday, addDays, format } from 'date-fns';
  import { generateDateRange, formatDisplayDate } from '../utils/date-utils';
  import { createElement, appendElement } from '../utils/dom-utils';
  import { dispatchDateSelected } from '../utils/event-utils';
  
  // Initialize the date picker
  function initDatepicker() {
    const today = startOfToday();
    const dates = generateDateRange(30);
    const datepicker = document.getElementById('datepicker');
    
    if (!datepicker) return;
    
    // Add dates to the grid
    dates.forEach((date, index) => {
      // Create date button
      const dateEl = createElement('button', {
        className: 'rounded-md h-8 w-8 flex items-center justify-center text-sm hover:bg-primary/10 transition-colors',
        'data-date': date.toISOString()
      }, date.getDate().toString());
      
      // Highlight first date (today)
      if (index === 0) {
        dateEl.classList.add('font-bold');
      }
      
      // Add date selection handler
      dateEl.addEventListener('click', () => {
        handleDateSelection(dateEl, date);
      });
      
      // Add to grid
      datepicker.appendChild(dateEl);
    });
  }
  
  // Handle date selection
  function handleDateSelection(element, date) {
    // Reset all date buttons
    document.querySelectorAll('#datepicker button').forEach(btn => {
      btn.classList.remove('bg-primary', 'text-white');
    });
    
    // Highlight selected button
    element.classList.add('bg-primary', 'text-white');
    
    // Update selected date display
    updateSelectedDateDisplay(date);
    
    // Dispatch date selection event
    dispatchDateSelected(date);
  }
  
  // Update the selected date display
  function updateSelectedDateDisplay(date) {
    const selectedDateDisplay = document.getElementById('selected-date-display');
    const selectedDateText = document.getElementById('selected-date');
    
    if (selectedDateDisplay && selectedDateText) {
      selectedDateText.textContent = formatDisplayDate(date);
      selectedDateDisplay.classList.remove('hidden');
    }
  }
  
  // Initialize when the DOM is loaded
  document.addEventListener('DOMContentLoaded', initDatepicker);
</script>